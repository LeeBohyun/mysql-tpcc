# MySQL-5.6 Anaylize Order-Line Table Split 

## Setup

btr0btr.cc in /storage/innobase/btr/

```bash
UNIV_INTERN
rec_t*
btr_page_split_and_insert{
...

 /* try to insert to the next page if possible before split */
        rec = btr_insert_into_right_sibling(
                flags, cursor, offsets, *heap, tuple, n_ext, mtr);

        if (rec != NULL) {
                return(rec);
        }
        /* start */
        if (buf_block_get_space(block) == srv_ol_space_id) {
                ib_logf(IB_LOG_LEVEL_INFO, "Split (%lu): original =  %lu / %lu / %d / %lu / %lu / %s\n",    
                rec_get_converted_size(cursor->index, tuple, n_ext), 
                buf_block_get_page_no(block), 
                page_get_n_recs(page), 
                page_is_leaf(page), 
                dict_index_is_clust(cursor->index), 
                dict_index_is_unique(cursor->index), 
                cursor->index->name);
     }
        /* end */

        page_no = buf_block_get_page_no(block);

        /* 1. Decide the split record; split_rec == NULL means that the
        tuple to be inserted should be the first record on the upper
        half-page */
        insert_left = FALSE;
...

/* Insert fit on the page: update the free bits for the
        left and right pages in the same mtr */

        if (!dict_index_is_clust(cursor->index) && page_is_leaf(page)) {
                ibuf_update_free_bits_for_two_pages_low(
                        buf_block_get_zip_size(left_block),
                        left_block, right_block, mtr);
        }

#if 0
        fprintf(stderr, "Split and insert done %lu %lu\n",
                buf_block_get_page_no(left_block),
                buf_block_get_page_no(right_block));
#endif
        /* start */
        if (buf_block_get_space(block) == srv_ol_space_id) {
                ib_logf(IB_LOG_LEVEL_INFO, "stderr, Split (%lu): original =  %lu / %lu / %d, new =  %lu / %lu / %d\n", 
                rec_get_converted_size(cursor->index, tuple, n_ext), 
                (ulint)buf_block_get_page_no(block), 
                page_get_n_recs(page), 
                page_is_leaf(page), 
                (ulint)buf_block_get_page_no(block), 
                page_get_n_recs(page), 
                page_is_leaf(page));
        }
        /* end */
        MONITOR_INC(MONITOR_INDEX_SPLIT);

        ut_ad(page_validate(buf_block_get_frame(left_block), cursor->index));
        ut_ad(page_validate(buf_block_get_frame(right_block), cursor->index));

        ut_ad(!rec || rec_offs_validate(rec, cursor->index, *offsets));
        return(rec);
...
}
```
### Used Function
```bash
/************************************************************//**
Determine whether the page is a B-tree leaf.
@return true if the page is a B-tree leaf (PAGE_LEVEL = 0) */
UNIV_INLINE
bool
page_is_leaf(
/*=========*/
        const page_t*   page)   /*!< in: page */
        __attribute__((nonnull, pure));

/*************************************************************//**
Gets the number of user records on page (the infimum and supremum records
are not user records).
@return number of user records */
UNIV_INLINE
ulint
page_get_n_recs(
/*============*/
        const page_t*   page);  /*!< in: index page */
        
/**********************************************************//**
The following function returns the size of a data tuple when converted to
a physical record.
@return size */
UNIV_INLINE
ulint
rec_get_converted_size(
/*===================*/
        dict_index_t*   index,  /*!< in: record descriptor */
        const dtuple_t* dtuple, /*!< in: data tuple */
        ulint           n_ext)  /*!< in: number of externally stored columns */
        __attribute__((warn_unused_result, nonnull));

/********************************************************************//**
Check whether the index is the clustered index.
@return nonzero for clustered index, zero for other indexes */
UNIV_INLINE
ulint
dict_index_is_clust(
/*================*/
        const dict_index_t*     index)  /*!< in: index */
        __attribute__((nonnull, pure, warn_unused_result));

/********************************************************************//**
Check whether the index is unique.
@return nonzero for unique index, zero for other indexes */
UNIV_INLINE
ulint
dict_index_is_unique(
/*=================*/
        const dict_index_t*     index)  /*!< in: index */
        MY_ATTRIBUTE((warn_unused_result));
```

## Experiment Results

### Origin(free space 6.25%) vs Tuned(free space 20%)
- buffer: 5G
- warehouse: 1000W(100G)
-page size:4k
- ```./tpcc_start -h127.0.0.1 -S/tmp/mysql.sock -P3306 -dtpcc1000 -uroot -p -w1000 -c4 -r10 -l7200``` 

### Result

||


